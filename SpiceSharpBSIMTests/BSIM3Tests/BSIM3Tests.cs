using System.IO;
using System.Numerics;
using NUnit.Framework;
using SpiceSharp;
using SpiceSharp.Components;
using SpiceSharp.Simulations;

namespace SpiceSharpBSIMTests.BSIM3Tests;

[TestFixture]
public class BSIM3Tests : Framework
{
    private BSIM3 CreateMosfet(string name, string drain, string gate, string source, string bulk, double w, double l, string model)
    {
        var e = new BSIM3(name, drain, gate, source, bulk);
        e.SetParameter("w", w);
        e.SetParameter("l", l);
        e.Model = model;
        return e;
    }

    private BSIM3Model CreateModel(string name, string parameters)
    {
        var m = new BSIM3Model(name);
        m.Parameters.CheckPath = Path.Combine(TestContext.CurrentContext.WorkDirectory, m.Parameters.CheckPath);
        ApplyParameters(m, parameters);
        return m;
    }

    [Test]
    public void When_BSIM3DC_Expect_Reference()
    {
        var ckt = new Circuit(
            new VoltageSource("V1", "g", "0", 0.0),
            new VoltageSource("V2", "d", "0", 0.0),
            CreateMosfet("M1", "d", "g", "0", "0", 10e-6, 1e-6, "mod"),
            CreateModel("mod", "tnom=27.0 nch=1.024685e+17 tox=1.00000e-08 xj=1.00000e-07 lint=3.75860e-08 wint=-2.02101528644562e-07 vth0=0.6094574 k1=0.5341038 k2=1.703463e-03 k3=-17.24589 dvt0=0.1767506 dvt1=0.5109418 dvt2=-0.05 nlx=9.979638e-08 w0=1e-6 k3b=4.139039 vsat=97662.05 ua=-1.748481e-09 ub=3.178541e-18 uc=1.3623e-10 rdsw=298.873 u0=307.2991 prwb=-2.24e-4 a0=0.4976366 keta=-2.195445e-02 a1=0.0332883 a2=0.9 voff=-9.623903e-02 nfactor=0.8408191 cit=3.994609e-04 cdsc=1.130797e-04 cdscb=2.4e-5 eta0=0.0145072 etab=-3.870303e-03 dsub=0.4116711 pclm=1.813153 pdiblc1=2.003703e-02 pdiblc2=0.00129051 pdiblcb=-1.034e-3 drout=0.4380235 pscbe1=5.752058e+08 pscbe2=7.510319e-05 pvag=0.6370527 prt=68.7 ngate=1.e20 alpha0=1.e-7 beta0=28.4 prwg=-0.001 ags=1.2 dvt0w=0.58 dvt1w=5.3e6 dvt2w=-0.0032 kt1=-.3 kt2=-.03 at=33000 ute=-1.5 ua1=4.31e-09 ub1=7.61e-18 uc1=-2.378e-10 kt1l=1e-8 wr=1 b0=1e-7 b1=1e-7 dwg=5e-8 dwb=2e-8 delta=0.015 cgdl=1e-10 cgsl=1e-10 cgbo=1e-10 xpart=0.0 cgdo=0.4e-9 cgso=0.4e-9 clc=0.1e-6 cle=0.6 ckappa=0.6"));
        ckt["M1"].SetParameter("m", 4.0);

        // Create simulation
        var dc = new DC("dc", new[]
        {
            new ParameterSweep("V1", new LinearSweep(0, 3.3, 0.3)),
            new ParameterSweep("V2", new LinearSweep(0, 3.3, 0.3))
        });

        // Create exports
        var exports = new IExport<double>[] { new RealPropertyExport(dc, "V2", "i") };

        // Create references
        // 20220723 - Sven Boulanger - using ngSpice
        double[][] references =
        {
            new[]
            {
                0.000000000000000e+00, -1.595146499776518e-12, -2.807634352560809e-12, -4.017234888613870e-12, -5.225919276112477e-12, -6.434200718852660e-12, -7.642283901651887e-12, -8.850279483808101e-12, -1.005832267386723e-11, -1.126676375181454e-11, -1.247648556950190e-11, -1.368930833543683e-11, 0.000000000000000e+00, -1.702513888540868e-09, -1.763452686034671e-09, -1.810555952711914e-09, -1.853266196006589e-09, -1.894042277341257e-09, -1.933864859867600e-09, -1.973264069395204e-09, -2.012887447249802e-09, -2.054412232737071e-09, -2.102065388504276e-09, -2.164561124979753e-09, 0.000000000000000e+00, -4.011822546282157e-06, -4.144754354442125e-06, -4.238399199443219e-06, -4.319314517986420e-06, -4.394374649542698e-06, -4.466322034720099e-06, -4.536594888506510e-06, -4.606724377824586e-06, -4.680375890159333e-06, -4.766707536358944e-06, -4.884644817681695e-06, 0.000000000000000e+00, -2.189866658944303e-04, -2.342042082884332e-04, -2.388553938327382e-04, -2.416785063960617e-04, -2.437635602569842e-04, -2.454719414096650e-04, -2.469626513779629e-04, -2.483282248860223e-04, -2.496821308035416e-04, -2.512884506128729e-04, -2.537513486274678e-04, 0.000000000000000e+00, -6.896923667685188e-04, -8.923967048149401e-04, -9.269238471927839e-04, -9.409073228156626e-04, -9.492225490320486e-04, -9.550880686092977e-04, -9.596662246583996e-04, -9.634908254231170e-04, -9.669069918218100e-04, -9.704272408598397e-04, -9.752830330202545e-04, 0.000000000000000e+00, -1.186836324449511e-03, -1.792490123948323e-03, -1.978445615398529e-03, -2.029150535546438e-03, -2.052612297165174e-03, -2.066861487933596e-03, -2.076879378469664e-03, -2.084603952937534e-03, -2.090978451147682e-03, -2.096739937378558e-03, -2.103263270430455e-03, 0.000000000000000e+00, -1.679323929663415e-03, -2.731082479103372e-03, -3.255846805354136e-03, -3.429265241742036e-03, -3.490193198059393e-03, -3.521095368926768e-03, -3.540471447175757e-03, -3.554245911481020e-03, -3.564889052564669e-03, -3.573718846559455e-03, -3.582110489487491e-03, 0.000000000000000e+00, -2.154793084532304e-03, -3.647107628178351e-03, -4.574314784957701e-03, -5.026335170197353e-03, -5.185731654196114e-03, -5.251294675037588e-03, -5.287112609576562e-03, -5.310356005611680e-03, -5.327161397945764e-03, -5.340272885878112e-03, -5.351411953217589e-03, 0.000000000000000e+00, -2.603772714264734e-03, -4.519034443029648e-03, -5.845167451231305e-03, -6.661188805408716e-03, -7.044407573859180e-03, -7.187995854676117e-03, -7.254447868360107e-03, -7.293098806221544e-03, -7.319027358284470e-03, -7.338131057193406e-03, -7.353278313480607e-03, 0.000000000000000e+00, -3.018755977114580e-03, -5.331772422198995e-03, -7.039321862879000e-03, -8.221866686861500e-03, -8.935249937356440e-03, -9.253231527710421e-03, -9.381851577347042e-03, -9.447262646673341e-03, -9.487370649235743e-03, -9.515104040423567e-03, -9.535934671557099e-03, 0.000000000000000e+00, -3.394186915842604e-03, -6.074195454675461e-03, -8.139503376272082e-03, -9.670987987395834e-03, -1.072988601132391e-02, -1.134274888729699e-02, -1.160535574898786e-02, -1.172150904200124e-02, -1.178522182023717e-02, -1.182604535287165e-02, -1.185503648301955e-02, 0.000000000000000e+00, -3.726485783761645e-03, -6.738837068198312e-03, -9.134121719433230e-03, -1.099204219641917e-02, -1.237648209368015e-02, -1.332562887101996e-02, -1.384215688652987e-02, -1.406330257017176e-02, -1.416990058360816e-02, -1.423200202126610e-02, -1.427325968194026e-02,
            }
        };

        // Run simulation
        AnalyzeDC(dc, ckt, exports, references);
    }

    [Test]
    public void When_BSIM3SmallSignal_Expect_Reference()
    {
        var ckt = new Circuit(
            new VoltageSource("Vsupply", "vdd", "0", 3.3),
            new VoltageSource("V1", "in", "0", 0.0),
            new Resistor("R1", "out", "g", 100.0e3),
            new CurrentSource("I1", "vdd", "out", 20e-6),
            new Capacitor("C1", "in", "g", 50e-12),
            CreateMosfet("M1", "out", "g", "0", "0", 10e-6, 1e-6, "mod"),
            CreateModel("mod", "tnom=27.0 nch=1.024685e+17 tox=1.00000e-08 xj=1.00000e-07 lint=3.75860e-08 wint=-2.02101528644562e-07 vth0=0.6094574 k1=0.5341038 k2=1.703463e-03 k3=-17.24589 dvt0=0.1767506 dvt1=0.5109418 dvt2=-0.05 nlx=9.979638e-08 w0=1e-6 k3b=4.139039 vsat=97662.05 ua=-1.748481e-09 ub=3.178541e-18 uc=1.3623e-10 rdsw=298.873 u0=307.2991 prwb=-2.24e-4 a0=0.4976366 keta=-2.195445e-02 a1=0.0332883 a2=0.9 voff=-9.623903e-02 nfactor=0.8408191 cit=3.994609e-04 cdsc=1.130797e-04 cdscb=2.4e-5 eta0=0.0145072 etab=-3.870303e-03 dsub=0.4116711 pclm=1.813153 pdiblc1=2.003703e-02 pdiblc2=0.00129051 pdiblcb=-1.034e-3 drout=0.4380235 pscbe1=5.752058e+08 pscbe2=7.510319e-05 pvag=0.6370527 prt=68.7 ngate=1.e20 alpha0=1.e-7 beta0=28.4 prwg=-0.001 ags=1.2 dvt0w=0.58 dvt1w=5.3e6 dvt2w=-0.0032 kt1=-.3 kt2=-.03 at=33000 ute=-1.5 ua1=4.31e-09 ub1=7.61e-18 uc1=-2.378e-10 kt1l=1e-8 wr=1 b0=1e-7 b1=1e-7 dwg=5e-8 dwb=2e-8 delta=0.015 cgdl=1e-10 cgsl=1e-10 cgbo=1e-10 xpart=0.0 cgdo=0.4e-9 cgso=0.4e-9 clc=0.1e-6 cle=0.6 ckappa=0.6"));
        ckt["V1"].SetParameter("acmag", 1.0);

        // Create simulation
        var ac = new AC("ac 1", new DecadeSweep(0.1, 1.0e9, 20));

        // Create exports
        var exports = new IExport<Complex>[] { new ComplexVoltageExport(ac, "out") };

        // Create reference
        // 20220723 - Sven Boulanger - using ngSpice
        double[] riref =
        {
            -4.625194770736049e-13,-2.987236637501707e-06, -5.822775231377030e-13,-3.351734634643840e-06, -7.330439705946127e-13,-3.760708113993407e-06, -9.228476825440440e-13,-4.219583905143694e-06, -1.161796398770039e-12,-4.734451011046709e-06, -1.462615009742538e-12,-5.312141405382915e-06, -1.841323203436410e-12,-5.960320688701081e-06, -2.318088572132285e-12,-6.687589806280236e-06, -2.918300610246896e-12,-7.503599177447883e-06, -3.673922797494096e-12,-8.419176750781229e-06, -4.625194770734989e-12,-9.446471684406117e-06, -5.822775231375450e-12,-1.059911555794396e-05, -7.330439705943662e-12,-1.189240325529124e-05, -9.228476825436479e-12,-1.334349591843621e-05, -1.161796398769408e-11,-1.497164866538650e-05, -1.462615009741550e-11,-1.679846609388641e-05, -1.841323203434841e-11,-1.884818896130268e-05, -2.318088572129791e-11,-2.114801584474694e-05, -2.918300610242935e-11,-2.372846404966904e-05, -3.673922797487844e-11,-2.662377455595895e-05, -4.625194770725079e-11,-2.987236637494632e-05, -5.822775231359710e-11,-3.351734634633844e-05, -7.330439705918629e-11,-3.760708113979290e-05, -9.228476825396934e-11,-4.219583905123753e-05, -1.161796398763145e-10,-4.734451011018547e-05, -1.462615009731614e-10,-5.312141405343135e-05, -1.841323203419108e-10,-5.960320688644895e-05, -2.318088572104832e-10,-6.687589806200871e-05, -2.918300610203418e-10,-7.503599177335779e-05, -3.673922797425174e-10,-8.419176750622881e-05, -4.625194770625757e-10,-9.446471684182449e-05, -5.822775231202315e-10,-1.059911555762802e-04, -7.330439705669168e-10,-1.189240325484498e-04, -9.228476825001608e-10,-1.334349591780584e-04, -1.161796398700485e-09,-1.497164866449609e-04, -1.462615009632291e-09,-1.679846609262867e-04, -1.841323203261686e-09,-1.884818895952608e-04, -2.318088571855358e-09,-2.114801584223745e-04, -2.918300609808026e-09,-2.372846404612429e-04, -3.673922796798539e-09,-2.662377455095188e-04, -4.625194769632617e-09,-2.987236636787365e-04, -5.822775229628292e-09,-3.351734633634805e-04, -7.330439703174623e-09,-3.760708112568112e-04, -9.228476821047870e-09,-4.219583903130413e-04, -1.161796398073860e-08,-4.734451008202882e-04, -1.462615008639173e-08,-5.312141401365905e-04, -1.841323201687712e-08,-5.960320683026906e-04, -2.318088569360776e-08,-6.687589798265252e-04, -2.918300605854358e-08,-7.503599166126425e-04, -3.673922790532385e-08,-8.419176734789255e-04, -4.625194759701450e-08,-9.446471661816857e-04, -5.822775213888483e-08,-1.059911552603579e-03, -7.330439678228645e-08,-1.189240321021977e-03, -9.228476781511215e-08,-1.334349585477106e-03, -1.161796391807735e-07,-1.497164857545710e-03, -1.462614998708015e-07,-1.679846596685777e-03, -1.841323185947867e-07,-1.884818878186997e-03, -2.318088544414822e-07,-2.114801559129153e-03, -2.918300566317672e-07,-2.372846369165375e-03, -3.673922727870986e-07,-2.662377405024895e-03, -4.625194660389842e-07,-2.987236566061200e-03, -5.822775056490148e-07,-3.351734533731443e-03, -7.330439428769162e-07,-3.760707971450862e-03, -9.228476386144488e-07,-4.219583703797006e-03, -1.161796329146333e-06,-4.734450726636965e-03, -1.462614899396409e-06,-5.312141003643482e-03, -1.841323028549593e-06,-5.960320121229067e-03, -2.318088294955359e-06,-6.687589004704738e-03, -2.918300170951105e-06,-7.503598045192443e-03, -3.673922101257197e-06,-8.419175151427984e-03, -4.625193667273981e-06,-9.446469425259733e-03, -5.822773482507738e-06,-1.059911236681508e-02, -7.330436934175255e-06,-1.189239874770226e-02, -9.228472432480167e-06,-1.334348955129817e-02, -1.161795702532849e-05,-1.497163967156609e-02, -1.462613906281113e-05,-1.679845338977940e-02, -1.841321454568265e-05,-1.884817101627809e-02, -2.318085800363746e-05,-2.114799049673223e-02, -2.918296217291176e-05,-2.372842824465768e-02, -3.673915835131192e-05,-2.662372398005588e-02, -4.625183736138897e-05,-2.987229493461945e-02, -5.822757742729944e-05,-3.351724543425695e-02, -7.330411988330072e-05,-3.760693859779998e-02, -9.228432896022406e-05,-4.219563770551801e-02, -1.161789436435073e-04,-4.734422570214780e-02, -1.462603975202360e-04,-5.312101231702356e-02, -1.841305714902972e-04,-5.960263941979845e-02, -2.318060854742850e-04,-6.687509649603088e-02, -2.918256681281118e-04,-7.503485953482507e-02, -3.673853175046628e-04,-8.419016818302544e-02, -4.625084427133420e-04,-9.446245774883863e-02, -5.822600349632730e-04,-1.059879645423326e-01, -7.330162539215552e-04,-1.189195251282450e-01, -9.228037550076500e-04,-1.334285923401215e-01, -1.161726779174709e-03,-1.497074933581750e-01, -1.462504671831791e-03,-1.679719577681520e-01, -1.841148333048541e-03,-1.884639462579467e-01, -2.317811428059958e-03,-2.114548134079774e-01, -2.917861380090259e-03,-2.372488407850621e-01, -3.673226691736434e-03,-2.661871790934224e-01, -4.624091571580169e-03,-2.986522402214618e-01, -5.821026886520100e-03,-3.350725812788400e-01, -7.327668981492827e-03,-3.759283226023927e-01, -9.224085952837191e-03,-4.217571394348073e-01, -1.161100578081917e-02,-4.731608614158145e-01, -1.461512379260368e-02,-5.308127035586542e-01, -1.839575992941089e-02,-5.954651347282220e-01, -2.315320110296032e-02,-6.679583615714400e-01, -2.913914250320937e-02,-7.492293628693513e-01, -3.666973589976291e-02,-8.403213451244798e-01, -4.614186410431476e-02,-9.423933962406119e-01, -5.805338901408602e-02,-1.056729978628321e+00, -7.302826395241835e-02,-1.184749710126972e+00, -9.184755321089810e-02,-1.328012609770461e+00, -1.154875497161756e-01,-1.488224608433049e+00, -1.451663012571032e-01,-1.667237607640421e+00, -1.823999045960265e-01,-1.867042672517166e+00, -2.290698358090296e-01,-2.089753021938106e+00, -2.875022452139682e-01,-2.337572287963891e+00, -3.605593910127716e-01,-2.612742032194144e+00, -4.517419779156716e-01,-2.917460748328499e+00, -5.652987772455876e-01,-3.253764661153955e+00, -7.063361165934956e-01,-3.623358837720575e+00, -8.809141740661954e-01,-4.027386029932970e+00, -1.096109098466871e+00,-4.466121280321069e+00, -1.360009736092179e+00,-4.938584245655218e+00, -1.681605912406665e+00,-5.442070681155342e+00, -2.070514050985281e+00,-5.971622272625272e+00, -2.536480068208990e+00,-6.519482319944602e+00, -3.088606626178904e+00,-7.074623818297348e+00, -3.734282062105503e+00,-7.622481340131079e+00, -4.477851010020171e+00,-8.145055450932258e+00, -5.319163580126737e+00,-8.621564923725805e+00, -6.252255187757952e+00,-9.029768990374659e+00, -7.264502346809033e+00,-9.347949230180744e+00, -8.336611646732223e+00,-9.557339254835291e+00, -9.443678329252950e+00,-9.644578862760707e+00, -1.055729555252725e+01,-9.603645176307348e+00, -1.164838114036732e+01,-9.436765205866926e+00, -1.269014774074147e+01,-9.154058587802691e+00, -1.366059199396974e+01,-8.772009693038713e+00, -1.454404429081600e+01,-8.311176228188645e+00, -1.533161963723560e+01,-7.793683604636382e+00, -1.602070575374321e+01,-7.241000973184168e+00, -1.661380969805479e+01,-6.672309408808512e+00, -1.711712738984053e+01,-6.103556576040550e+00, -1.753913584643225e+01,-5.547124783551085e+00, -1.788939608209706e+01,-5.011951869077586e+00, -1.817764620379470e+01,-4.503927719065586e+00, -1.841318565339015e+01,-4.026416178340026e+00, -1.860450768241445e+01,-3.580795842152220e+00, -1.875912097656447e+01,-3.166955902160950e+00, -1.888350249519363e+01,-2.783716536021120e+00, -1.898313310869726e+01,-2.429165591538747e+00, -1.906257953380815e+01,-2.100916159386490e+00, -1.912559715853069e+01,-1.796295726757713e+00, -1.917523729996227e+01,-1.512479462734407e+00, -1.921394902907749e+01,-1.246579702500247e+00, -1.924367021677944e+01,-9.957021321311258e-01, -1.926590535950762e+01,-7.569772801844089e-01, -1.928178947559497e+01,-5.275740975131115e-01, -1.929213829273585e+01,-3.047008355985931e-01, -1.929748534810280e+01,-8.559717643147391e-02, -1.929810669031405e+01,1.324793774154474e-01, -1.929403373797730e+01,3.522705006766848e-01, -1.928505459962000e+01,5.765354774930573e-01, -1.927070385260408e+01,8.080692749459435e-01, -1.925024045730171e+01,1.049718398169541e+00, -1.922261318759538e+01,1.304392366539011e+00, -1.918641273861768e+01,1.575068096416190e+00, -1.913980959811899e+01,1.864783637192632e+00, -1.908047694638168e+01,2.176616547862131e+00, -1.900549844390815e+01,2.513640694500972e+00, -1.891126201493293e+01,2.878853404423106e+00, -1.879334297192765e+01,3.275062823190303e+00, -1.864638348742609e+01,3.704723239261063e+00, -1.846398101549012e+01,4.169704598202038e+00, -1.823860628178045e+01,4.670982389556634e+00, -1.796158212453840e+01,5.208237131619014e+00, -1.762316729691386e+01,5.779361108058466e+00, -1.721280242052675e+01,6.379886742058780e+00, -1.671958431328050e+01,7.002378891768968e+00, -1.613303236826307e+01,7.635873598119311e+00, -1.544418586227048e+01,8.265495023298653e+00, -1.464701270365814e+01,8.872428753303231e+00, -1.374001266734061e+01,9.434450522639132e+00, -1.272777222532828e+01,9.927173356032213e+00, -1.162211028615426e+01,1.032605546310912e+01, -1.044240639958715e+01,1.060900502485170e+01, -9.214789827929467e+00,1.075917513191068e+01, -7.970112737982073e+00,1.076736204801511e+01, -6.740975746242389e+00,1.063341222438336e+01, -5.558383970026497e+00,1.036625693372616e+01, -4.448740511100301e+00,9.982565108608542e+00, -3.431766522988369e+00,9.504380735522854e+00, -2.519632600429514e+00,8.956334321768676e+00, -1.717239451335526e+00,8.363020213570106e+00, -1.023334272088137e+00,7.746957258812574e+00, -4.320550181632048e-01,7.127307847158942e+00, 6.546246872628148e-02,6.519320915709723e+00, 4.796634723563407e-01,5.934339559468209e+00,
        };
        var references = new Complex[1][];
        references[0] = new Complex[riref.Length / 2];
        for (var i = 0; i < riref.Length; i += 2)
            references[0][i / 2] = new Complex(riref[i], riref[i + 1]);

        // run simulation
        AnalyzeAC(ac, ckt, exports, references);
    }

    [Test]
    public void When_BSIM3Transient_Expect_NoErrors()
    {
        var ckt = new Circuit(
            new VoltageSource("V1", "g", "0", new Pulse(0, 5, 0.1e-7, 1e-9, 1e-9, 0.6e-6, 1e-6)),
            new VoltageSource("V2", "vdd", "0", 3.3),
            new Resistor("R1", "vdd", "d", 1e6),
            CreateMosfet("M1", "d", "g", "0", "0", 10e-6, 1e-6, "mod"),
            CreateModel("mod", "tnom=27.0 nch=1.024685e+17 tox=1.00000e-08 xj=1.00000e-07 lint=3.75860e-08 wint=-2.02101528644562e-07 vth0=0.6094574 k1=0.5341038 k2=1.703463e-03 k3=-17.24589 dvt0=0.1767506 dvt1=0.5109418 dvt2=-0.05 nlx=9.979638e-08 w0=1e-6 k3b=4.139039 vsat=97662.05 ua=-1.748481e-09 ub=3.178541e-18 uc=1.3623e-10 rdsw=298.873 u0=307.2991 prwb=-2.24e-4 a0=0.4976366 keta=-2.195445e-02 a1=0.0332883 a2=0.9 voff=-9.623903e-02 nfactor=0.8408191 cit=3.994609e-04 cdsc=1.130797e-04 cdscb=2.4e-5 eta0=0.0145072 etab=-3.870303e-03 dsub=0.4116711 pclm=1.813153 pdiblc1=2.003703e-02 pdiblc2=0.00129051 pdiblcb=-1.034e-3 drout=0.4380235 pscbe1=5.752058e+08 pscbe2=7.510319e-05 pvag=0.6370527 prt=68.7 ngate=1.e20 alpha0=1.e-7 beta0=28.4 prwg=-0.001 ags=1.2 dvt0w=0.58 dvt1w=5.3e6 dvt2w=-0.0032 kt1=-.3 kt2=-.03 at=33000 ute=-1.5 ua1=4.31e-09 ub1=7.61e-18 uc1=-2.378e-10 kt1l=1e-8 wr=1 b0=1e-7 b1=1e-7 dwg=5e-8 dwb=2e-8 delta=0.015 cgdl=1e-10 cgsl=1e-10 cgbo=1e-10 xpart=0.0 cgdo=0.4e-9 cgso=0.4e-9 clc=0.1e-6 cle=0.6 ckappa=0.6"));
        ckt["M1"].SetParameter("m", 4.0);

        var tran = new Transient("Transient 1", 1e-8, 10e-6);
        var export = new RealVoltageExport(tran, "d");

        foreach (int _ in tran.Run(ckt, Transient.ExportTransient))
        {
            Assert.That(export.Value, Is.LessThan(4.0));
            Assert.That(export.Value, Is.GreaterThan(-1.0));
        }
    }

    [Test]
    public void When_BSIM3AggregateModel_Expect_NoErrors()
    {
        var ckt = new Circuit(
            new VoltageSource("V1", "g", "0", 0.0),
            new VoltageSource("V2", "d", "0", 0.0),
            CreateMosfet("M1", "d", "g", "0", "0", 10e-6, 1e-6, "mod"),
            CreateMosfet("M2", "d", "g", "0", "0", 10e-6, 1.5e-6, "mod"),
            new BSIM3AggregateModel(
                "mod",
                [
                    CreateModel("mod.1", "lmin=0.5e-6 lmax=1e-6 wmin=0.5e-6 wmax=100e-6 tnom=27.0 nch=1.024685e+17 tox=1.00000e-08 xj=1.00000e-07 lint=3.75860e-08 wint=-2.02101528644562e-07 vth0=0.6094574 k1=0.5341038 k2=1.703463e-03 k3=-17.24589 dvt0=0.1767506 dvt1=0.5109418 dvt2=-0.05 nlx=9.979638e-08 w0=1e-6 k3b=4.139039 vsat=97662.05 ua=-1.748481e-09 ub=3.178541e-18 uc=1.3623e-10 rdsw=298.873 u0=307.2991 prwb=-2.24e-4 a0=0.4976366 keta=-2.195445e-02 a1=0.0332883 a2=0.9 voff=-9.623903e-02 nfactor=0.8408191 cit=3.994609e-04 cdsc=1.130797e-04 cdscb=2.4e-5 eta0=0.0145072 etab=-3.870303e-03 dsub=0.4116711 pclm=1.813153 pdiblc1=2.003703e-02 pdiblc2=0.00129051 pdiblcb=-1.034e-3 drout=0.4380235 pscbe1=5.752058e+08 pscbe2=7.510319e-05 pvag=0.6370527 prt=68.7 ngate=1.e20 alpha0=1.e-7 beta0=28.4 prwg=-0.001 ags=1.2 dvt0w=0.58 dvt1w=5.3e6 dvt2w=-0.0032 kt1=-.3 kt2=-.03 at=33000 ute=-1.5 ua1=4.31e-09 ub1=7.61e-18 uc1=-2.378e-10 kt1l=1e-8 wr=1 b0=1e-7 b1=1e-7 dwg=5e-8 dwb=2e-8 delta=0.015 cgdl=1e-10 cgsl=1e-10 cgbo=1e-10 xpart=0.0 cgdo=0.4e-9 cgso=0.4e-9 clc=0.1e-6 cle=0.6 ckappa=0.6"),
                    CreateModel("mod.2", "lmin=1e-6 lmax=2e-6 wmin=0.5e-6 wmax=100e-6 tnom=27.0 nch=1.024685e+17 tox=1.00000e-08 xj=1.00000e-07 lint=3.75860e-08 wint=-2.02101528644562e-07 vth0=0.6094574 k1=0.5341038 k2=1.703463e-03 k3=-17.24589 dvt0=0.1767506 dvt1=0.5109418 dvt2=-0.05 nlx=9.979638e-08 w0=1e-6 k3b=4.139039 vsat=97662.05 ua=-1.748481e-09 ub=3.178541e-18 uc=1.3623e-10 rdsw=298.873 u0=307.2991 prwb=-2.24e-4 a0=0.4976366 keta=-2.195445e-02 a1=0.0332883 a2=0.9 voff=-9.623903e-02 nfactor=0.8408191 cit=3.994609e-04 cdsc=1.130797e-04 cdscb=2.4e-5 eta0=0.0145072 etab=-3.870303e-03 dsub=0.4116711 pclm=1.813153 pdiblc1=2.003703e-02 pdiblc2=0.00129051 pdiblcb=-1.034e-3 drout=0.4380235 pscbe1=5.752058e+08 pscbe2=7.510319e-05 pvag=0.6370527 prt=68.7 ngate=1.e20 alpha0=1.e-7 beta0=28.4 prwg=-0.001 ags=1.2 dvt0w=0.58 dvt1w=5.3e6 dvt2w=-0.0032 kt1=-.3 kt2=-.03 at=33000 ute=-1.5 ua1=4.31e-09 ub1=7.61e-18 uc1=-2.378e-10 kt1l=1e-8 wr=1 b0=1e-7 b1=1e-7 dwg=5e-8 dwb=2e-8 delta=0.015 cgdl=1e-10 cgsl=1e-10 cgbo=1e-10 xpart=0.0 cgdo=0.4e-9 cgso=0.4e-9 clc=0.1e-6 cle=0.6 ckappa=0.6")
                ]));
        ckt["M1"].SetParameter("m", 4.0);

        // Create simulation
        var dc = new DC("dc",
        [
            new ParameterSweep("V1", new LinearSweep(0, 3.3, 0.3)),
            new ParameterSweep("V2", new LinearSweep(0, 3.3, 0.3))
        ]);

        // Make sure the right models are being used
        bool hit = false;
        foreach (var state in dc.Run(ckt, -1))
        {
            if (state == BiasingSimulation.AfterTemperature)
            {
                // Make sure that the right models are being used
                var m1Behavior = dc.EntityBehaviors["M1"].GetValue<SpiceSharpBSIM.Components.Semiconductors.BSIM.BSIM3Behaviors.BiasingBehavior>();
                Assert.That(m1Behavior.ModelName, Is.EqualTo("mod.1"));
                var m2Behavior = dc.EntityBehaviors["M2"].GetValue<SpiceSharpBSIM.Components.Semiconductors.BSIM.BSIM3Behaviors.BiasingBehavior>();
                Assert.That(m2Behavior.ModelName, Is.EqualTo("mod.2"));
                hit = true;
            }
        }
        Assert.That(hit, Is.True);
    }
}
