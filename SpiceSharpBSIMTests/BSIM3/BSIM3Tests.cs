using System.IO;
using System.Numerics;
using NUnit.Framework;
using SpiceSharp;
using SpiceSharp.Components;
using SpiceSharp.Components.BSIM3Behaviors;
using SpiceSharp.Simulations;

namespace SpiceSharpTest.Models
{
    [TestFixture]
    public class BSIM3Tests : Framework
    {
        /// <summary>
        /// Generate a BSIM1 transistor
        /// </summary>
        private BSIM3 Create(Identifier name, Identifier drain, Identifier gate, Identifier source, Identifier bulk, double w, double l, Identifier model, string parameters)
        {
            // Create the model
            var m = new BSIM3Model(model);
            m.ParameterSets.Get<ModelBaseParameters>().CheckPath = Path.Combine(TestContext.CurrentContext.WorkDirectory, "bsim3check.log");
            ApplyParameters(m, parameters);

            // Create the device
            var e = new BSIM3(name, drain, gate, source, bulk);
            e.SetParameter("w", w);
            e.SetParameter("l", l);
            e.SetModel(m);
            return e;
        }

        [Test]
        public void When_BSIM3DC_Expect_Reference()
        {
            var ckt = new Circuit(
                new VoltageSource("V1", "g", "0", 0.0),
                new VoltageSource("V2", "d", "0", 0.0),
                Create("M1", "d", "g", "0", "0", 10e-6, 1e-6, "mod", "tnom=27.0 nch=1.024685e+17 tox=1.00000e-08 xj=1.00000e-07 lint=3.75860e-08 wint=-2.02101528644562e-07 vth0=0.6094574 k1=0.5341038 k2=1.703463e-03 k3=-17.24589 dvt0=0.1767506 dvt1=0.5109418 dvt2=-0.05 nlx=9.979638e-08 w0=1e-6 k3b=4.139039 vsat=97662.05 ua=-1.748481e-09 ub=3.178541e-18 uc=1.3623e-10 rdsw=298.873 u0=307.2991 prwb=-2.24e-4 a0=0.4976366 keta=-2.195445e-02 a1=0.0332883 a2=0.9 voff=-9.623903e-02 nfactor=0.8408191 cit=3.994609e-04 cdsc=1.130797e-04 cdscb=2.4e-5 eta0=0.0145072 etab=-3.870303e-03 dsub=0.4116711 pclm=1.813153 pdiblc1=2.003703e-02 pdiblc2=0.00129051 pdiblcb=-1.034e-3 drout=0.4380235 pscbe1=5.752058e+08 pscbe2=7.510319e-05 pvag=0.6370527 prt=68.7 ngate=1.e20 alpha0=1.e-7 beta0=28.4 prwg=-0.001 ags=1.2 dvt0w=0.58 dvt1w=5.3e6 dvt2w=-0.0032 kt1=-.3 kt2=-.03 at=33000 ute=-1.5 ua1=4.31e-09 ub1=7.61e-18 uc1=-2.378e-10 kt1l=1e-8 wr=1 b0=1e-7 b1=1e-7 dwg=5e-8 dwb=2e-8 delta=0.015 cgdl=1e-10 cgsl=1e-10 cgbo=1e-10 xpart=0.0 cgdo=0.4e-9 cgso=0.4e-9 clc=0.1e-6 cle=0.6 ckappa=0.6"));

            // Create simulation
            var dc = new DC("dc", new[]
            {
                new SweepConfiguration("V1", 0, 3.3, 0.3),
                new SweepConfiguration("V2", 0, 3.3, 0.3),
            });

            // Create exports
            Export<double>[] exports = { new RealPropertyExport(dc, "V2", "i") };

            // Create references
            double[][] references =
            {
                new[]
                {
                    0.000000000000000e+00, -3.987866249441294e-13, -7.019085881402023e-13, -1.004308722153467e-12,
                    -1.306479819028119e-12, -1.608550179713165e-12, -1.910570975412972e-12, -2.212569870952025e-12,
                    -2.514580668466807e-12, -2.816690937953634e-12, -3.119121392375476e-12, -3.422327083859208e-12,
                    0.000000000000000e+00, -4.256284721352169e-10, -4.408631715086678e-10, -4.526389881779776e-10,
                    -4.633165490016473e-10, -4.735105693353143e-10, -4.834662149668999e-10, -4.933160173488011e-10,
                    -5.032218618124506e-10, -5.136030581842678e-10, -5.255163471260690e-10, -5.411402812449383e-10,
                    0.000000000000000e+00, -1.002955636570539e-06, -1.036188588610531e-06, -1.059599799860805e-06,
                    -1.079828629496605e-06, -1.098593662385674e-06, -1.116580508680025e-06, -1.134148722126627e-06,
                    -1.151681094456145e-06, -1.170093972539833e-06, -1.191676884089736e-06, -1.221161204420424e-06,
                    0.000000000000000e+00, -5.474666647360758e-05, -5.855105207210829e-05, -5.971384845818454e-05,
                    -6.041962659901544e-05, -6.094089006424604e-05, -6.136798535241625e-05, -6.174066284449074e-05,
                    -6.208205622150557e-05, -6.242053270088540e-05, -6.282211265321822e-05, -6.343783715686695e-05,
                    0.000000000000000e+00, -1.724230916921297e-04, -2.230991762037350e-04, -2.317309617981960e-04,
                    -2.352268307039156e-04, -2.373056372580121e-04, -2.387720171523244e-04, -2.399165561645999e-04,
                    -2.408727063557793e-04, -2.417267479554525e-04, -2.426068102149599e-04, -2.438207582550636e-04,
                    0.000000000000000e+00, -2.967090811123777e-04, -4.481225309870807e-04, -4.946114038496322e-04,
                    -5.072876338866096e-04, -5.131530742912935e-04, -5.167153719833990e-04, -5.192198446174160e-04,
                    -5.211509882343836e-04, -5.227446127869205e-04, -5.241849843446395e-04, -5.258158176076138e-04,
                    0.000000000000000e+00, -4.198309824158539e-04, -6.827706197758429e-04, -8.139617013385339e-04,
                    -8.573163104355090e-04, -8.725482995148484e-04, -8.802738422316919e-04, -8.851178617939393e-04,
                    -8.885614778702550e-04, -8.912222631411672e-04, -8.934297116398636e-04, -8.955276223718727e-04,
                    0.000000000000000e+00, -5.386982711330761e-04, -9.117769070445878e-04, -1.143578696239425e-03,
                    -1.256583792549338e-03, -1.296432913549028e-03, -1.312823668759397e-03, -1.321778152394141e-03,
                    -1.327589001402920e-03, -1.331790349486441e-03, -1.335068221469528e-03, -1.337852988304397e-03,
                    0.000000000000000e+00, -6.509431785661836e-04, -1.129758610757412e-03, -1.461291862807826e-03,
                    -1.665297201352179e-03, -1.761101893464795e-03, -1.796998963669029e-03, -1.813611967090027e-03,
                    -1.823274701555386e-03, -1.829756839571118e-03, -1.834532764298351e-03, -1.838319578370152e-03,
                    0.000000000000000e+00, -7.546889942786451e-04, -1.332943105549748e-03, -1.759830465719750e-03,
                    -2.055466671715375e-03, -2.233812484339110e-03, -2.313307881927605e-03, -2.345462894336760e-03,
                    -2.361815661668335e-03, -2.371842662308936e-03, -2.378776010105892e-03, -2.383983667889275e-03,
                    0.000000000000000e+00, -8.485467289606510e-04, -1.518548863668865e-03, -2.034875844068021e-03,
                    -2.417746996848958e-03, -2.682471502830978e-03, -2.835687221824247e-03, -2.901338937246964e-03,
                    -2.930377260500309e-03, -2.946305455059293e-03, -2.956511338217913e-03, -2.963759120754886e-03,
                    0.000000000000000e+00, -9.316214459404112e-04, -1.684709267049578e-03, -2.283530429858308e-03,
                    -2.748010549104793e-03, -3.094120523420038e-03, -3.331407217754991e-03, -3.460539221632467e-03,
                    -3.515825642542940e-03, -3.542475145902040e-03, -3.558000505316525e-03, -3.568314920485064e-03
                }
            };
            
            // Run simulation
            AnalyzeDC(dc, ckt, exports, references);
        }

        [Test]
        public void When_BSIM3SmallSignal_Expect_Reference()
        {
            var ckt = new Circuit(
                new VoltageSource("Vsupply", "vdd", "0", 3.3),
                new VoltageSource("V1", "in", "0", 0.0),
                new Resistor("R1", "out", "g", 100.0e3),
                new CurrentSource("I1", "vdd", "out", 20e-6),
                new Capacitor("C1", "in", "g", 50e-12),
                Create("M1", "out", "g", "0", "0", 10e-6, 1e-6, "mod", "tnom=27.0 nch=1.024685e+17 tox=1.00000e-08 xj=1.00000e-07 lint=3.75860e-08 wint=-2.02101528644562e-07 vth0=0.6094574 k1=0.5341038 k2=1.703463e-03 k3=-17.24589 dvt0=0.1767506 dvt1=0.5109418 dvt2=-0.05 nlx=9.979638e-08 w0=1e-6 k3b=4.139039 vsat=97662.05 ua=-1.748481e-09 ub=3.178541e-18 uc=1.3623e-10 rdsw=298.873 u0=307.2991 prwb=-2.24e-4 a0=0.4976366 keta=-2.195445e-02 a1=0.0332883 a2=0.9 voff=-9.623903e-02 nfactor=0.8408191 cit=3.994609e-04 cdsc=1.130797e-04 cdscb=2.4e-5 eta0=0.0145072 etab=-3.870303e-03 dsub=0.4116711 pclm=1.813153 pdiblc1=2.003703e-02 pdiblc2=0.00129051 pdiblcb=-1.034e-3 drout=0.4380235 pscbe1=5.752058e+08 pscbe2=7.510319e-05 pvag=0.6370527 prt=68.7 ngate=1.e20 alpha0=1.e-7 beta0=28.4 prwg=-0.001 ags=1.2 dvt0w=0.58 dvt1w=5.3e6 dvt2w=-0.0032 kt1=-.3 kt2=-.03 at=33000 ute=-1.5 ua1=4.31e-09 ub1=7.61e-18 uc1=-2.378e-10 kt1l=1e-8 wr=1 b0=1e-7 b1=1e-7 dwg=5e-8 dwb=2e-8 delta=0.015 cgdl=1e-10 cgsl=1e-10 cgbo=1e-10 xpart=0.0 cgdo=0.4e-9 cgso=0.4e-9 clc=0.1e-6 cle=0.6 ckappa=0.6"));
            ckt.Objects["V1"].SetParameter("acmag", 1.0);

            // Create simulation
            var ac = new AC("ac 1", new DecadeSweep(0.1, 1.0e9, 20));

            // Create exports
            Export<Complex>[] exports = { new ComplexVoltageExport(ac, "out") };

            // Create reference
            double[] riref =
            {
                -4.625185918640073e-13, -2.987236949814749e-06, -5.822764087248476e-13, -3.351734985064835e-06,
                -7.330425676319563e-13, -3.760708507172233e-06, -9.228459163187030e-13, -4.219584346297591e-06,
                -1.161794175224067e-12, -4.734451506029524e-06, -1.462612210464009e-12, -5.312141960762767e-06,
                -1.841319679353539e-12, -5.960321311847524e-06, -2.318084135574803e-12, -6.687590505462044e-06,
                -2.918295024951948e-12, -7.503599961942775e-06, -3.673915766024323e-12, -8.419177630998976e-06,
                -4.625185918639085e-12, -9.446472672026671e-06, -5.822764087246919e-12, -1.059911666607245e-05,
                -7.330425676317030e-12, -1.189240449863186e-05, -9.228459163183063e-12, -1.334349731348732e-05,
                -1.161794175223433e-11, -1.497165023065960e-05, -1.462612210463008e-11, -1.679846785015170e-05,
                -1.841319679351964e-11, -1.884819093186474e-05, -2.318084135572306e-11, -2.114801805575395e-05,
                -2.918295024947995e-11, -2.372846653045970e-05, -3.673915766018077e-11, -2.662377733945186e-05,
                -4.625185918629109e-11, -2.987236949807674e-05, -5.822764087231153e-11, -3.351734985054842e-05,
                -7.330425676292059e-11, -3.760708507158116e-05, -9.228459163143487e-11, -4.219584346277650e-05,
                -1.161794175217175e-10, -4.734451506001361e-05, -1.462612210453076e-10, -5.312141960722987e-05,
                -1.841319679336215e-10, -5.960321311791336e-05, -2.318084135547351e-10, -6.687590505382679e-05,
                -2.918295024908448e-10, -7.503599961830671e-05, -3.673915765955408e-10, -8.419177630840628e-05,
                -4.625185918529817e-10, -9.446472671803003e-05, -5.822764087073732e-10, -1.059911666575651e-04,
                -7.330425676042581e-10, -1.189240449818559e-04, -9.228459162748049e-10, -1.334349731285696e-04,
                -1.161794175154507e-09, -1.497165022976919e-04, -1.462612210353767e-09, -1.679846784889397e-04,
                -1.841319679178806e-09, -1.884819093008817e-04, -2.318084135297885e-09, -2.114801805324448e-04,
                -2.918295024513065e-09, -2.372846652691498e-04, -3.673915765328804e-09, -2.662377733444481e-04,
                -4.625185917536687e-09, -2.987236949100409e-04, -5.822764085499786e-09, -3.351734984055805e-04,
                -7.330425673547980e-09, -3.760708505746941e-04, -9.228459158794437e-09, -4.219584344284318e-04,
                -1.161794174527900e-08, -4.734451503185706e-04, -1.462612209360644e-08, -5.312141956745771e-04,
                -1.841319677604843e-08, -5.960321306173370e-04, -2.318084132803310e-08, -6.687590497447091e-04,
                -2.918295020559423e-08, -7.503599950621361e-04, -3.673915759062692e-08, -8.419177615007061e-04,
                -4.625185907605578e-08, -9.446472649437502e-04, -5.822764069760006e-08, -1.059911663416440e-03,
                -7.330425648602219e-08, -1.189240445356056e-03, -9.228459119258020e-08, -1.334349724982243e-03,
                -1.161794168261791e-07, -1.497165014073055e-03, -1.462612199429554e-07, -1.679846772312356e-03,
                -1.841319661865105e-07, -1.884819075243275e-03, -2.318084107857500e-07, -2.114801780229954e-03,
                -2.918294981022999e-07, -2.372846617244583e-03, -3.673915696401675e-07, -2.662377683374386e-03,
                -4.625185808294539e-07, -2.987236878374522e-03, -5.822763912362637e-07, -3.351734884152837e-03,
                -7.330425399144193e-07, -3.760708364630249e-03, -9.228458723893669e-07, -4.219584144951695e-03,
                -1.161794105600780e-06, -4.734451221620898e-03, -1.462612100118537e-06, -5.312141559024915e-03,
                -1.841319504467762e-06, -5.960320744377743e-03, -2.318083858399534e-06, -6.687589703889702e-03,
                -2.918294585658772e-06, -7.503598829691790e-03, -3.673915069791605e-06, -8.419176031652027e-03,
                -4.625184815184577e-06, -9.446470412889180e-03, -5.822762338389572e-06, -1.059911347495613e-02,
                -7.330422904565208e-06, -1.189239999106062e-02, -9.228454770252855e-06, -1.334349094637435e-02,
                -1.161793478991009e-05, -1.497164123687459e-02, -1.462611107009161e-05, -1.679845514609470e-02,
                -1.841317930495814e-05, -1.884817298691079e-02, -2.318081363822773e-05, -2.114799270783901e-02,
                -2.918290632022372e-05, -2.372843072558927e-02, -3.673908803702921e-05, -2.662372676374784e-02,
                -4.625174884108655e-05, -2.987229805803105e-02, -5.822746598705590e-05, -3.351724893886408e-02,
                -7.330397958868560e-05, -3.760694253014923e-02, -9.228415234030746e-05, -4.219564211784944e-02,
                -1.161787212930576e-04, -4.734423065309531e-02, -1.462601175989571e-04, -5.312101787240321e-02,
                -1.841302190924306e-04, -5.960264565349629e-02, -2.318056418350511e-04, -6.687510349100373e-02,
                -2.918251096247857e-04, -7.503486738423022e-02, -3.673846143991662e-04, -8.419017699149745e-02,
                -4.625075575694828e-04, -9.446246763393537e-02, -5.822589206546085e-04, -1.059879756361765e-01,
                -7.330148511240173e-04, -1.189195375793908e-01, -9.228019890439934e-04, -1.334286063156902e-01,
                -1.161724556043481e-03, -1.497075090462999e-01, -1.462501873210596e-03, -1.679719753807986e-01,
                -1.841144810007432e-03, -1.884639660341824e-01, -2.317806993153509e-03, -2.114548356177889e-01,
                -2.917855797411856e-03, -2.372488657338485e-01, -3.673219664413405e-03, -2.661872071273336e-01,
                -4.624082726055773e-03, -2.986522717338077e-01, -5.821015752805650e-03, -3.350726167178720e-01,
                -7.327654968369318e-03, -3.759283624808682e-01, -9.224068316735112e-03, -4.217571843418987e-01,
                -1.161098358679805e-02, -4.731609120321253e-01, -1.461509586547693e-02, -5.308127606754013e-01,
                -1.839572479260987e-02, -5.954651992720446e-01, -2.315315690219044e-02, -6.679584346368507e-01,
                -2.913908691132289e-02, -7.492294457616349e-01, -3.666966599855220e-02, -8.403214394169195e-01,
                -4.614177623814919e-02, -9.423935038514284e-01, -5.805327860950665e-02, -1.056730101924774e+00,
                -7.302812529708536e-02, -1.184749852066904e+00, -9.184737918481667e-02, -1.328012774095418e+00,
                -1.154873314682244e-01, -1.488224799932283e+00, -1.451660278210422e-01, -1.667237832511971e+00,
                -1.823995624431716e-01, -1.867042938861149e+00, -2.290694083408826e-01, -2.089753340428702e+00,
                -2.875017122090909e-01, -2.337572672760312e+00, -3.605587280607222e-01, -2.612742502166729e+00,
                -4.517411559004509e-01, -2.917461328692305e+00, -5.652977619862376e-01, -3.253765385615385e+00,
                -7.063348688152504e-01, -3.623359751245727e+00, -8.809126499660125e-01, -4.027387192227581e+00,
                -1.096107251252523e+00, -4.466122770052260e+00, -1.360007519005311e+00, -4.938586165317829e+00,
                -1.681603283860076e+00, -5.442073162257642e+00, -2.070510982496446e+00, -5.971625480510213e+00,
                -2.536476555699367e+00, -6.519486457067471e+00, -3.088602704799049e+00, -7.074629124203476e+00,
                -3.734277823902961e+00, -7.622488085881502e+00, -4.477846622436839e+00, -8.145063925618254e+00,
                -5.319159301661199e+00, -8.621575411411904e+00, -6.252251375679986e+00, -9.029781737672925e+00,
                -7.264499451441535e+00, -9.347964407667460e+00, -8.336610188429884e+00, -9.557356918941103e+00,
                -9.443678858115817e+00, -9.644598927121082e+00, -1.055729859618331e+01, -9.603667401216688e+00,
                -1.164838714974090e+01, -9.436789210719070e+00, -1.269015704530139e+01, -9.154083885254384e+00,
                -1.366060477550754e+01, -8.772035737609551e+00, -1.454406057937460e+01, -8.311202468679657e+00,
                -1.533163932684815e+01, -7.793709530210906e+00, -1.602072863149753e+01, -7.241026146389650e+00,
                -1.661383547870179e+01, -6.672333483297327e+00, -1.711715574929484e+01, -6.103579300482981e+00,
                -1.753916644987823e+01, -5.547145995336406e+00, -1.788942860486372e+01, -5.011971481904911e+00,
                -1.817768034501477e+01, -4.503945707970830e+00, -1.841322114352706e+01, -4.026432564697153e+00,
                -1.860454428614689e+01, -3.580810680164177e+00, -1.875915849249433e+01, -3.166969267539690e+00,
                -1.888354075360377e+01, -2.783728517004751e+00, -1.898317196828087e+01, -2.429176282075227e+00,
                -1.906261887800553e+01, -2.100925654164798e+00, -1.912563689187655e+01, -1.796304117726823e+00,
                -1.917527734467550e+01, -1.512486836769746e+00, -1.921398932200705e+01, -1.246586139923926e+00,
                -1.924371070674436e+01, -9.957077058467994e-01, -1.926594600502360e+01, -7.569820552397502e-01,
                -1.928183024295491e+01, -5.275781309479028e-01, -1.929217915439994e+01, -3.047041764732052e-01,
                -1.929752628135022e+01, -8.559986595928840e-02, -1.929814767610857e+01, 1.324773056861628e-01,
                -1.929407476000234e+01, 3.522690206694554e-01, -1.928509564344170e+01, 5.765345704242121e-01,
                -1.927074490492483e+01, 8.080689291765804e-01, -1.925028150526897e+01, 1.049718609098071e+00,
                -1.922265421813261e+01, 1.304393136538221e+00, -1.918645373774506e+01, 1.575069434813673e+00,
                -1.913985055023159e+01, 1.864785560288318e+00, -1.908051783345145e+01, 2.176619078970685e+00,
                -1.900553924457453e+01, 2.513643863999465e+00, -1.891130270344482e+01, 2.878857249774525e+00,
                -1.879338351689784e+01, 3.275067388900294e+00, -1.864642385035963e+01, 3.704728576707527e+00,
                -1.846402114905212e+01, 4.169710765253725e+00, -1.823864612778005e+01, 4.670989449866572e+00,
                -1.796162161163008e+01, 5.208245153441810e+00, -1.762320633806087e+01, 5.779370162398871e+00,
                -1.721284091034467e+01, 6.379896899919582e+00, -1.671962212549228e+01, 7.002390220242907e+00,
                -1.613306935365497e+01, 7.635886155087919e+00, -1.544422184773581e+01, 8.265508850599019e+00,
                -1.464704749311732e+01, 8.872443868448793e+00, -1.374004604545487e+01, 9.434466909569867e+00,
                -1.272780396485725e+01, 9.927190955913430e+00, -1.162214015940359e+01, 1.032607416679126e+01,
                -1.044243419357422e+01, 1.060902466901653e+01, -9.214815361762025e+00, 1.075919550085541e+01,
                -7.970135879839396e+00, 1.076738288223303e+01, -6.740996426779120e+00, 1.063343323563937e+01,
                -5.558402189396154e+00, 1.036627782463292e+01, -4.448756338136889e+00, 9.982585593454385e+00,
                -3.431780086925831e+00, 9.504400558824473e+00, -2.519644077166670e+00, 8.956353271805973e+00,
                -1.717249047107374e+00, 8.363038129609299e+00, -1.023342207339522e+00, 7.746974032225987e+00,
                -4.320615136886594e-01, 7.127323417720660e+00, 6.545720229454544e-02, 6.519335264804500e+00,
                4.796592415082184e-01, 5.934352701887263e+00,
            };
            var references = new Complex[1][];
            references[0] = new Complex[riref.Length / 2];
            for (var i = 0; i < riref.Length; i += 2)
                references[0][i / 2] = new Complex(riref[i], riref[i + 1]);

            // run simulation
            AnalyzeAC(ac, ckt, exports, references);
        }
    }
}
