using System.IO;
using System.Numerics;
using NUnit.Framework;
using SpiceSharp;
using SpiceSharp.Components;
using SpiceSharp.Simulations;

namespace SpiceSharpTest.Models
{
    [TestFixture]
    public class BSIM3v2Tests : Framework
    {
        private BSIM3v2 CreateMosfet(string name, string drain, string gate, string source, string bulk, double w, double l, string model)
        {
            var e = new BSIM3v2(name, drain, gate, source, bulk);
            e.SetParameter("w", w);
            e.SetParameter("l", l);
            e.Model = model;
            return e;
        }

        private BSIM3v2Model CreateModel(string name, string parameters)
        {
            var m = new BSIM3v2Model(name);
            m.Parameters.CheckPath = Path.Combine(TestContext.CurrentContext.WorkDirectory, m.Parameters.CheckPath);
            ApplyParameters(m, parameters);
            return m;
        }

        [Test]
        public void When_BSIM3v2DC_Expect_Reference()
        {
            var ckt = new Circuit(
                new VoltageSource("V1", "g", "0", 0.0),
                new VoltageSource("V2", "d", "0", 0.0),
                CreateMosfet("M1", "d", "g", "0", "0", 10e-6, 1e-6, "mod"),
                CreateModel("mod", "tnom=27.0 nch=1.024685e+17 tox=1.00000e-08 xj=1.00000e-07 lint=3.75860e-08 wint=-2.02101528644562e-07 vth0=0.6094574 k1=0.5341038 k2=1.703463e-03 k3=-17.24589 dvt0=0.1767506 dvt1=0.5109418 dvt2=-0.05 nlx=9.979638e-08 w0=1e-6 k3b=4.139039 vsat=97662.05 ua=-1.748481e-09 ub=3.178541e-18 uc=1.3623e-10 rdsw=298.873 u0=307.2991 prwb=-2.24e-4 a0=0.4976366 keta=-2.195445e-02 a1=0.0332883 a2=0.9 voff=-9.623903e-02 nfactor=0.8408191 cit=3.994609e-04 cdsc=1.130797e-04 cdscb=2.4e-5 eta0=0.0145072 etab=-3.870303e-03 dsub=0.4116711 pclm=1.813153 pdiblc1=2.003703e-02 pdiblc2=0.00129051 pdiblcb=-1.034e-3 drout=0.4380235 pscbe1=5.752058e+08 pscbe2=7.510319e-05 pvag=0.6370527 prt=68.7 ngate=1.e20 alpha0=1.e-7 beta0=28.4 prwg=-0.001 ags=1.2 dvt0w=0.58 dvt1w=5.3e6 dvt2w=-0.0032 kt1=-.3 kt2=-.03 at=33000 ute=-1.5 ua1=4.31e-09 ub1=7.61e-18 uc1=-2.378e-10 kt1l=1e-8 wr=1 b0=1e-7 b1=1e-7 dwg=5e-8 dwb=2e-8 delta=0.015 cgdl=1e-10 cgsl=1e-10 cgbo=1e-10 xpart=0.0 cgdo=0.4e-9 cgso=0.4e-9 clc=0.1e-6 cle=0.6 ckappa=0.6"));
            ckt["M1"].SetParameter("m", 4.0);

            // Create simulation
            var dc = new DC("dc", new[]
            {
                new ParameterSweep("V1", new LinearSweep(0, 3.3, 0.3)),
                new ParameterSweep("V2", new LinearSweep(0, 3.3, 0.3))
            });

            // Create exports
            var exports = new IExport<double>[] { new RealPropertyExport(dc, "V2", "i") };

            // Create references
            // 20220723 - Sven Boulanger - using ngSpice
            double[][] references =
            {
                new[]
                {
                    0.000000000000000e+00, -1.595146499776518e-12, -2.807634352560809e-12, -4.017234888613870e-12, -5.225919276112477e-12, -6.434200718852660e-12, -7.642283901651887e-12, -8.850279483808101e-12, -1.005832267386723e-11, -1.126676375181454e-11, -1.247648556950190e-11, -1.368930833543683e-11, 0.000000000000000e+00, -1.702513888540868e-09, -1.763452686034671e-09, -1.810555952711914e-09, -1.853266196006589e-09, -1.894042277341257e-09, -1.933864859867600e-09, -1.973264069395204e-09, -2.012887447249802e-09, -2.054412232737071e-09, -2.102065388504276e-09, -2.164561124979753e-09, 0.000000000000000e+00, -4.011822546282157e-06, -4.144754354442125e-06, -4.238399199443219e-06, -4.319314517986420e-06, -4.394374649542698e-06, -4.466322034720099e-06, -4.536594888506510e-06, -4.606724377824586e-06, -4.680375890159333e-06, -4.766707536358944e-06, -4.884644817681695e-06, 0.000000000000000e+00, -2.189866658944303e-04, -2.342042082884332e-04, -2.388553938327382e-04, -2.416785063960617e-04, -2.437635602569842e-04, -2.454719414096650e-04, -2.469626513779629e-04, -2.483282248860223e-04, -2.496821308035416e-04, -2.512884506128729e-04, -2.537513486274678e-04, 0.000000000000000e+00, -6.896923667685188e-04, -8.923967048149401e-04, -9.269238471927839e-04, -9.409073228156626e-04, -9.492225490320486e-04, -9.550880686092977e-04, -9.596662246583996e-04, -9.634908254231170e-04, -9.669069918218100e-04, -9.704272408598397e-04, -9.752830330202545e-04, 0.000000000000000e+00, -1.186836324449511e-03, -1.792490123948323e-03, -1.978445615398529e-03, -2.029150535546438e-03, -2.052612297165174e-03, -2.066861487933596e-03, -2.076879378469664e-03, -2.084603952937534e-03, -2.090978451147682e-03, -2.096739937378558e-03, -2.103263270430455e-03, 0.000000000000000e+00, -1.679323929663415e-03, -2.731082479103372e-03, -3.255846805354136e-03, -3.429265241742036e-03, -3.490193198059393e-03, -3.521095368926768e-03, -3.540471447175757e-03, -3.554245911481020e-03, -3.564889052564669e-03, -3.573718846559455e-03, -3.582110489487491e-03, 0.000000000000000e+00, -2.154793084532304e-03, -3.647107628178351e-03, -4.574314784957701e-03, -5.026335170197353e-03, -5.185731654196114e-03, -5.251294675037588e-03, -5.287112609576562e-03, -5.310356005611680e-03, -5.327161397945764e-03, -5.340272885878112e-03, -5.351411953217589e-03, 0.000000000000000e+00, -2.603772714264734e-03, -4.519034443029648e-03, -5.845167451231305e-03, -6.661188805408716e-03, -7.044407573859180e-03, -7.187995854676117e-03, -7.254447868360107e-03, -7.293098806221544e-03, -7.319027358284470e-03, -7.338131057193406e-03, -7.353278313480607e-03, 0.000000000000000e+00, -3.018755977114580e-03, -5.331772422198995e-03, -7.039321862879000e-03, -8.221866686861500e-03, -8.935249937356440e-03, -9.253231527710421e-03, -9.381851577347042e-03, -9.447262646673341e-03, -9.487370649235743e-03, -9.515104040423567e-03, -9.535934671557099e-03, 0.000000000000000e+00, -3.394186915842604e-03, -6.074195454675461e-03, -8.139503376272082e-03, -9.670987987395834e-03, -1.072988601132391e-02, -1.134274888729699e-02, -1.160535574898786e-02, -1.172150904200124e-02, -1.178522182023717e-02, -1.182604535287165e-02, -1.185503648301955e-02, 0.000000000000000e+00, -3.726485783761645e-03, -6.738837068198312e-03, -9.134121719433230e-03, -1.099204219641917e-02, -1.237648209368015e-02, -1.332562887101996e-02, -1.384215688652987e-02, -1.406330257017176e-02, -1.416990058360816e-02, -1.423200202126610e-02, -1.427325968194026e-02,
                }
            };

            // Run simulation
            AnalyzeDC(dc, ckt, exports, references);
        }

        [Test]
        public void When_BSIM3v2SmallSignal_Expect_Reference()
        {
            var ckt = new Circuit(
                new VoltageSource("Vsupply", "vdd", "0", 3.3),
                new VoltageSource("V1", "in", "0", 0.0),
                new Resistor("R1", "out", "g", 100.0e3),
                new CurrentSource("I1", "vdd", "out", 20e-6),
                new Capacitor("C1", "in", "g", 50e-12),
                CreateMosfet("M1", "out", "g", "0", "0", 10e-6, 1e-6, "mod"),
                CreateModel("mod", "tnom=27.0 nch=1.024685e+17 tox=1.00000e-08 xj=1.00000e-07 lint=3.75860e-08 wint=-2.02101528644562e-07 vth0=0.6094574 k1=0.5341038 k2=1.703463e-03 k3=-17.24589 dvt0=0.1767506 dvt1=0.5109418 dvt2=-0.05 nlx=9.979638e-08 w0=1e-6 k3b=4.139039 vsat=97662.05 ua=-1.748481e-09 ub=3.178541e-18 uc=1.3623e-10 rdsw=298.873 u0=307.2991 prwb=-2.24e-4 a0=0.4976366 keta=-2.195445e-02 a1=0.0332883 a2=0.9 voff=-9.623903e-02 nfactor=0.8408191 cit=3.994609e-04 cdsc=1.130797e-04 cdscb=2.4e-5 eta0=0.0145072 etab=-3.870303e-03 dsub=0.4116711 pclm=1.813153 pdiblc1=2.003703e-02 pdiblc2=0.00129051 pdiblcb=-1.034e-3 drout=0.4380235 pscbe1=5.752058e+08 pscbe2=7.510319e-05 pvag=0.6370527 prt=68.7 ngate=1.e20 alpha0=1.e-7 beta0=28.4 prwg=-0.001 ags=1.2 dvt0w=0.58 dvt1w=5.3e6 dvt2w=-0.0032 kt1=-.3 kt2=-.03 at=33000 ute=-1.5 ua1=4.31e-09 ub1=7.61e-18 uc1=-2.378e-10 kt1l=1e-8 wr=1 b0=1e-7 b1=1e-7 dwg=5e-8 dwb=2e-8 delta=0.015 cgdl=1e-10 cgsl=1e-10 cgbo=1e-10 xpart=0.0 cgdo=0.4e-9 cgso=0.4e-9 clc=0.1e-6 cle=0.6 ckappa=0.6"));
            ckt["V1"].SetParameter("acmag", 1.0);

            // Create simulation
            var ac = new AC("ac 1", new DecadeSweep(0.1, 1.0e9, 20));

            // Create exports
            var exports = new IExport<Complex>[] { new ComplexVoltageExport(ac, "out") };

            // Create reference
            // 20220723 - Sven Boulanger - using ngSpice
            double[] riref =
            {
                -4.625195576998411e-13,-2.987236637501707e-06, -5.822776246401232e-13,-3.351734634643839e-06, -7.330440983785950e-13,-3.760708113993407e-06, -9.228478434145464e-13,-4.219583905143694e-06, -1.161796601294000e-12,-4.734451011046709e-06, -1.462615264705084e-12,-5.312141405382914e-06, -1.841323524415259e-12,-5.960320688701081e-06, -2.318088976220697e-12,-6.687589806280236e-06, -2.918301118964065e-12,-7.503599177447884e-06, -3.673923437931073e-12,-8.419176750781229e-06, -4.625195576997393e-12,-9.446471684406115e-06, -5.822776246399655e-12,-1.059911555794396e-05, -7.330440983783439e-12,-1.189240325529124e-05, -9.228478434141522e-12,-1.334349591843621e-05, -1.161796601293370e-11,-1.497164866538650e-05, -1.462615264704092e-11,-1.679846609388641e-05, -1.841323524413680e-11,-1.884818896130267e-05, -2.318088976218206e-11,-2.114801584474694e-05, -2.918301118960108e-11,-2.372846404966903e-05, -3.673923437924802e-11,-2.662377455595896e-05, -4.625195576987462e-11,-2.987236637494630e-05, -5.822776246383920e-11,-3.351734634633845e-05, -7.330440983758448e-11,-3.760708113979291e-05, -9.228478434101926e-11,-4.219583905123753e-05, -1.161796601287102e-10,-4.734451011018547e-05, -1.462615264694156e-10,-5.312141405343137e-05, -1.841323524397926e-10,-5.960320688644894e-05, -2.318088976193257e-10,-6.687589806200868e-05, -2.918301118920570e-10,-7.503599177335780e-05, -3.673923437862153e-10,-8.419176750622880e-05, -4.625195576888146e-10,-9.446471684182449e-05, -5.822776246226529e-10,-1.059911555762802e-04, -7.330440983509028e-10,-1.189240325484498e-04, -9.228478433706434e-10,-1.334349591780584e-04, -1.161796601224441e-09,-1.497164866449609e-04, -1.462615264594849e-09,-1.679846609262867e-04, -1.841323524240533e-09,-1.884818895952608e-04, -2.318088975943788e-09,-2.114801584223745e-04, -2.918301118525208e-09,-2.372846404612429e-04, -3.673923437235518e-09,-2.662377455095188e-04, -4.625195575895037e-09,-2.987236636787365e-04, -5.822776244652543e-09,-3.351734633634804e-04, -7.330440981014403e-09,-3.760708112568111e-04, -9.228478429752855e-09,-4.219583903130412e-04, -1.161796600597823e-08,-4.734451008202880e-04, -1.462615263601728e-08,-5.312141401365903e-04, -1.841323522666549e-08,-5.960320683026904e-04, -2.318088973449199e-08,-6.687589798265249e-04, -2.918301114571547e-08,-7.503599166126423e-04, -3.673923430969380e-08,-8.419176734789249e-04, -4.625195565963864e-08,-9.446471661816852e-04, -5.822776228912648e-08,-1.059911552603578e-03, -7.330440956068415e-08,-1.189240321021976e-03, -9.228478390216157e-08,-1.334349585477104e-03, -1.161796594331678e-07,-1.497164857545708e-03, -1.462615253670557e-07,-1.679846596685773e-03, -1.841323506926712e-07,-1.884818878186992e-03, -2.318088948503215e-07,-2.114801559129145e-03, -2.918301075034835e-07,-2.372846369165365e-03, -3.673923368307947e-07,-2.662377405024880e-03, -4.625195466652213e-07,-2.987236566061178e-03, -5.822776071514276e-07,-3.351734533731414e-03, -7.330440706608843e-07,-3.760707971450822e-03, -9.228477994849316e-07,-4.219583703796945e-03, -1.161796531670267e-06,-4.734450726636881e-03, -1.462615154358920e-06,-5.312141003643365e-03, -1.841323349528351e-06,-5.960320121228902e-03, -2.318088699043668e-06,-6.687589004704503e-03, -2.918300679668096e-06,-7.503598045192111e-03, -3.673922741693916e-06,-8.419175151427509e-03, -4.625194473535939e-06,-9.446469425259063e-03, -5.822774497531144e-06,-1.059911236681414e-02, -7.330438212013957e-06,-1.189239874770093e-02, -9.228474041183274e-06,-1.334348955129630e-02, -1.161795905056510e-05,-1.497163967156344e-02, -1.462614161243202e-05,-1.679845338977566e-02, -1.841321775546378e-05,-1.884817101627279e-02, -2.318086204451019e-05,-2.114799049672475e-02, -2.918296726006544e-05,-2.372842824464712e-02, -3.673916475565285e-05,-2.662372398004096e-02, -4.625184542396692e-05,-2.987229493459838e-02, -5.822758757746899e-05,-3.351724543422719e-02, -7.330413266158327e-05,-3.760693859775793e-02, -9.228434504709180e-05,-4.219563770545864e-02, -1.161789638956133e-04,-4.734422570206392e-02, -1.462604230160333e-04,-5.312101231690507e-02, -1.841306035874559e-04,-5.960263941963109e-02, -2.318061258819769e-04,-6.687509649579447e-02, -2.918257189980025e-04,-7.503485953449116e-02, -3.673853815454667e-04,-8.419016818255379e-02, -4.625085233349955e-04,-9.446245774817238e-02, -5.822601364584273e-04,-1.059879645413915e-01, -7.330163816940162e-04,-1.189195251269156e-01, -9.228039158598982e-04,-1.334285923382438e-01, -1.161726981669720e-03,-1.497074933555228e-01, -1.462504926748504e-03,-1.679719577644057e-01, -1.841148653954724e-03,-1.884639462526550e-01, -2.317811832033258e-03,-2.114548134005030e-01, -2.917861888624980e-03,-2.372488407745049e-01, -3.673227331884243e-03,-2.661871790785111e-01, -4.624092377384328e-03,-2.986522402004009e-01, -5.821027900818093e-03,-3.350725812490940e-01, -7.327670258181804e-03,-3.759283225603811e-01, -9.224087559718541e-03,-4.217571393754751e-01, -1.161100780316907e-02,-4.731608613320243e-01, -1.461512633765044e-02,-5.308127034403307e-01, -1.839576313194458e-02,-5.954651345611450e-01, -2.315320513235125e-02,-6.679583613355426e-01, -2.913914757217456e-02,-7.492293625363247e-01, -3.666974227529485e-02,-8.403213446543996e-01, -4.614187212126897e-02,-9.423933955771964e-01, -5.805339909201668e-02,-1.056729977692270e+00, -7.302827661635092e-02,-1.184749708806625e+00, -9.184756911681169e-02,-1.328012607908722e+00, -1.154875696820444e-01,-1.488224605809122e+00, -1.451663263003478e-01,-1.667237603944385e+00, -1.823999359781284e-01,-1.867042667314707e+00, -2.290698750877794e-01,-2.089753014621831e+00, -2.875022943032172e-01,-2.337572277686521e+00, -3.605594522484594e-01,-2.612742017777584e+00, -4.517420541250594e-01,-2.917460728141255e+00, -5.652988718137222e-01,-3.253764632948033e+00, -7.063362335165509e-01,-3.623358798418025e+00, -8.809143179751669e-01,-4.027385975352600e+00, -1.096109274596954e+00,-4.466121204838623e+00, -1.360009950163438e+00,-4.938584141797342e+00, -1.681606170371900e+00,-5.442070539141345e+00, -2.070514358594573e+00,-5.971622079893111e+00, -2.536480430343536e+00,-6.519482060729796e+00, -3.088607045927935e+00,-7.074623473373184e+00, -3.734282539608928e+00,-7.622480886855737e+00, -4.477851541181333e+00,-8.145054863764990e+00, -5.319164155406265e+00,-8.621564175343179e+00, -6.252255791361222e+00,-9.029768053413955e+00, -7.264502956622819e+00,-9.347948079457661e+00, -8.336612235291316e+00,-9.557337869666265e+00, -9.443678865798942e+00,-9.644577228854025e+00, -1.055729600590477e+01,-9.603643286674483e+00, -1.164838148220981e+01,-9.436763060399468e+00, -1.269014794826978e+01,-9.154056191511181e+00, -1.366059205183480e+01,-8.772007053314287e+00, -1.454404419171265e+01,-8.311173351671256e+00, -1.533161938136002e+01,-7.793680494278573e+00, -1.602070534742169e+01,-7.240997625924278e+00, -1.661380915196786e+01,-6.672305814018411e+00, -1.711712671722108e+01,-6.103552714695740e+00, -1.753913506149280e+01,-5.547120627940482e+00, -1.788939519880677e+01,-5.011947382830114e+00, -1.817764523502006e+01,-4.503922857292197e+00, -1.841318461034961e+01,-4.026410887740175e+00, -1.860450657436927e+01,-3.580790060987426e+00, -1.875911981066528e+01,-3.166949560041977e+00, -1.888350127641154e+01,-2.783709553485356e+00, -1.898313183978215e+01,-2.429157879411760e+00, -1.906257821522975e+01,-2.100907617929783e+00, -1.912559578836787e+01,-1.796286244606588e+00, -1.917523587371232e+01,-1.512468915628312e+00, -1.921394753935974e+01,-1.246567951804834e+00, -1.924366865290702e+01,-9.956890231476441e-01, -1.926590370689820e+01,-7.569626402388473e-01, -1.928178771498496e+01,-5.275577338149228e-01, -1.929213639915463e+01,-3.046825328575456e-01, -1.929748328955243e+01,-8.557669422130458e-02, -1.929810442608633e+01,1.325023075556663e-01, -1.929403121652294e+01,3.522961784075695e-01, -1.928505175586450e+01,5.765642371015908e-01, -1.927070060458020e+01,8.081014890149558e-01, -1.925023670194020e+01,1.049754481449628e+00, -1.922260879548244e+01,1.304432779950846e+00, -1.918640754749176e+01,1.575113351065585e+00, -1.913980340484149e+01,1.864834298216297e+00, -1.908046949708016e+01,2.176673237832668e+00, -1.900548942196295e+01,2.513704095997861e+00, -1.891125102646997e+01,2.878924261213953e+00, -1.879332952850822e+01,3.275141939255388e+00, -1.864636698571613e+01,3.704811474628778e+00, -1.846396071388417e+01,4.169802860245015e+00, -1.823858127430079e+01,4.671091618044544e+00, -1.796155131289328e+01,5.208358275478274e+00, -1.762312936244767e+01,5.779495091538648e+00, -1.721275579898340e+01,6.380034418002533e+00, -1.671952717682376e+01,7.002540980158064e+00, -1.613296262092207e+01,7.636050609330814e+00, -1.544410115655412e+01,8.265687167879204e+00, -1.464691048685497e+01,8.872635843761520e+00, -1.373989026503617e+01,9.434671877599099e+00, -1.272762696588386e+01,9.927407722226699e+00, -1.162193966268312e+01,1.032630097437980e+01, -1.044220825592504e+01,1.060925921715242e+01, -9.214562544645029e+00,1.075943502716964e+01, -7.969855387632898e+00,1.076762430727969e+01, -6.740688187912601e+00,1.063367335465395e+01, -5.558066863325313e+00,1.036651351868058e+01, -4.448395246788043e+00,9.982814026752513e+00, -3.431395085318993e+00,9.504619333038553e+00, -2.519237388803270e+00,8.956560519758094e+00, -1.716823092419414e+00,8.363232545306415e+00, -1.022899448786537e+00,7.747154846341432e+00, -4.316043322383822e-01,7.127490334642663e+00, 6.592659386127897e-02,6.519488378805843e+00, 4.801388502437243e-01,5.934492407446659e+00,
            };
            var references = new Complex[1][];
            references[0] = new Complex[riref.Length / 2];
            for (var i = 0; i < riref.Length; i += 2)
                references[0][i / 2] = new Complex(riref[i], riref[i + 1]);

            // run simulation
            AnalyzeAC(ac, ckt, exports, references);
        }

        [Test]
        public void When_BSIM3Transient_Expect_NoErrors()
        {
            var ckt = new Circuit(
                new VoltageSource("V1", "g", "0", new Pulse(0, 5, 0.1e-7, 1e-9, 1e-9, 0.6e-6, 1e-6)),
                new VoltageSource("V2", "vdd", "0", 3.3),
                new Resistor("R1", "vdd", "d", 1e6),
                CreateMosfet("M1", "d", "g", "0", "0", 10e-6, 1e-6, "mod"),
                CreateModel("mod", "tnom=27.0 nch=1.024685e+17 tox=1.00000e-08 xj=1.00000e-07 lint=3.75860e-08 wint=-2.02101528644562e-07 vth0=0.6094574 k1=0.5341038 k2=1.703463e-03 k3=-17.24589 dvt0=0.1767506 dvt1=0.5109418 dvt2=-0.05 nlx=9.979638e-08 w0=1e-6 k3b=4.139039 vsat=97662.05 ua=-1.748481e-09 ub=3.178541e-18 uc=1.3623e-10 rdsw=298.873 u0=307.2991 prwb=-2.24e-4 a0=0.4976366 keta=-2.195445e-02 a1=0.0332883 a2=0.9 voff=-9.623903e-02 nfactor=0.8408191 cit=3.994609e-04 cdsc=1.130797e-04 cdscb=2.4e-5 eta0=0.0145072 etab=-3.870303e-03 dsub=0.4116711 pclm=1.813153 pdiblc1=2.003703e-02 pdiblc2=0.00129051 pdiblcb=-1.034e-3 drout=0.4380235 pscbe1=5.752058e+08 pscbe2=7.510319e-05 pvag=0.6370527 prt=68.7 ngate=1.e20 alpha0=1.e-7 beta0=28.4 prwg=-0.001 ags=1.2 dvt0w=0.58 dvt1w=5.3e6 dvt2w=-0.0032 kt1=-.3 kt2=-.03 at=33000 ute=-1.5 ua1=4.31e-09 ub1=7.61e-18 uc1=-2.378e-10 kt1l=1e-8 wr=1 b0=1e-7 b1=1e-7 dwg=5e-8 dwb=2e-8 delta=0.015 cgdl=1e-10 cgsl=1e-10 cgbo=1e-10 xpart=0.0 cgdo=0.4e-9 cgso=0.4e-9 clc=0.1e-6 cle=0.6 ckappa=0.6"));
            ckt["M1"].SetParameter("m", 4.0);

            var tran = new Transient("Transient 1", 1e-8, 10e-6);
            var export = new RealVoltageExport(tran, "d");

            foreach (int _ in tran.Run(ckt, Transient.ExportTransient))
            {
                Assert.That(export.Value, Is.LessThan(4.0));
                Assert.That(export.Value, Is.GreaterThan(-1.0));
            }
        }
    }
}
